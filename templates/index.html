<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clientes Phantom / GigaredPlay</title>
<style>
  :root {
    --bg:#0d1117;
    --bg-alt:#161b22;
    --card:#161b22;
    --card-border:#30363d;
    --card-highlight:rgba(56,139,253,0.12);
    --text:#c9d1d9;
    --muted:#8b949e;
    --accent:#58a6ff;
    --accent-soft:rgba(88,166,255,0.16);
    --success:#22c55e;
    --warn:#f59e0b;
    --danger:#ef4444;
    --chip-bg:rgba(110,118,129,0.2);
    --chip-on:rgba(78,184,120,0.22);
    --chip-off:rgba(153,76,76,0.22);
    --shadow:0 6px 16px rgba(1,4,9,0.28);
    --radius-xl:16px;
    --radius-lg:12px;
    --radius-md:8px;
    --radius-sm:6px;
    --transition:all 160ms ease;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);font:14px/1.6 "Segoe UI", "Inter", system-ui, sans-serif;-webkit-font-smoothing:antialiased;}
  .app{max-width:960px;margin:0 auto;padding:32px 24px 64px;}
  .hero{position:relative;padding:28px;border-radius:var(--radius-xl);border:1px solid var(--card-border);background:var(--card);box-shadow:var(--shadow);overflow:hidden;}
  .hero::after{display:none;}
  .hero>*{position:relative;z-index:1;}
  h1{margin:0;font-size:24px;line-height:1.25;font-weight:600;letter-spacing:0;}
  .hero p{margin:8px 0 0;color:var(--muted);max-width:520px;font-size:13px;}
  .hero-note{margin:12px 0 0;color:var(--muted);font-size:12px;}
  .session-bar{margin-top:16px;display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted);}
  .session-bar strong{color:var(--text);}
  .role-pill{display:inline-flex;align-items:center;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid var(--card-border);background:var(--bg-alt);color:var(--text);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;}
  .logout-btn{padding:6px 12px;font-size:12px;}
  .search-bar{margin-top:20px;display:grid;grid-template-columns:minmax(0,1fr) auto auto;gap:10px;padding:10px 12px;border-radius:var(--radius-lg);border:1px solid var(--card-border);background:var(--bg-alt);align-items:center;transition:var(--transition);}
  .search-bar:focus-within{border-color:var(--accent);box-shadow:0 0 0 1px rgba(88,166,255,0.35);}
  .input-wrap{position:relative;display:flex;align-items:center;}
  label{position:absolute;left:10px;top:-9px;padding:0 6px;border-radius:999px;background:var(--bg);color:var(--muted);font-size:10px;letter-spacing:0.08em;text-transform:uppercase;font-weight:600;}
  #ida{width:100%;padding:10px 12px;border-radius:var(--radius-md);border:1px solid var(--card-border);background:var(--bg);color:var(--text);font-size:14px;font-weight:500;letter-spacing:0.01em;}
  #ida::placeholder{color:rgba(139,148,158,0.6);font-weight:400;}
  #ida:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 1px rgba(88,166,255,0.35);}
  .btn-primary{position:relative;display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border-radius:var(--radius-md);border:1px solid rgba(88,166,255,0.4);background:var(--bg);color:var(--accent);font-weight:600;cursor:pointer;transition:var(--transition);box-shadow:none;}
  .btn-primary:hover{background:rgba(88,166,255,0.08);}
  .btn-primary:active{background:rgba(88,166,255,0.12);}
  .btn-primary:disabled{cursor:not-allowed;opacity:0.5;}
  .btn-primary .spinner{width:14px;height:14px;border-radius:50%;border:2px solid rgba(88,166,255,0.35);border-top-color:var(--accent);animation:spin 0.7s linear infinite;display:none;}
  #open-ph-btn{white-space:nowrap;padding:10px 16px;}
  .search-bar.is-loading .btn-primary .spinner{display:inline-block;}
  .search-bar.is-loading .btn-primary .btn-text{opacity:0.0;}
  @keyframes spin{to{transform:rotate(360deg);}}
  #status{margin-top:16px;display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;background:var(--bg-alt);color:var(--muted);font-size:12px;font-weight:500;letter-spacing:0.03em;text-transform:uppercase;border:1px solid var(--card-border);}
  #status[data-tone="success"]{background:rgba(46,160,67,0.15);color:#7ee787;}
  #status[data-tone="warn"]{background:rgba(174,124,20,0.14);color:#e3b341;}
  #status[data-tone="error"]{background:rgba(196,84,84,0.16);color:#f29b9b;}
  #status[data-tone="loading"]{background:rgba(56,139,253,0.15);color:#9cc4ff;}
  .results{margin-top:28px;}
  .results.results--empty .placeholder{display:flex;}
  .card-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));}
  .card{position:relative;z-index:0;border-radius:var(--radius-lg);border:1px solid var(--card-border);background:var(--card);padding:20px 20px 18px;box-shadow:var(--shadow);overflow:hidden;transition:var(--transition);}
  .card::before{display:none;}
  .card:hover{border-color:rgba(88,166,255,0.4);}
  .card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:14px;}
  .card-eyebrow{margin:0;font-size:11px;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);font-weight:600;}
  .card-title{margin:4px 0 0;font-size:18px;font-weight:600;letter-spacing:0;color:var(--text);}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;background:var(--bg-alt);color:var(--muted);}
  .badge--success{background:rgba(63,185,80,0.18);color:#4ade80;}
  .badge--warn{background:rgba(174,124,20,0.2);color:#facc15;}
  .badge--danger{background:rgba(184,65,65,0.25);color:#f87171;}
  .data-list{display:grid;gap:12px;}
  .data-row{display:grid;gap:0px;grid-template-columns:90px minmax(0,1fr) min-content;align-items:center;}
  .data-label{font-size:11px;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted);font-weight:600;}
  .data-value{font-size:14px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .copy{border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:6px 10px;background:var(--bg);color:var(--muted);font-weight:500;cursor:pointer;transition:var(--transition);}
  .copy:hover{border-color:var(--accent);color:var(--accent);}
  .services{display:flex;flex-wrap:wrap;gap:6px;}
  .chip{display:flex;flex-direction:column;gap:1px;padding:6px 8px;border-radius:var(--radius-sm);border:1px solid var(--card-border);background:var(--chip-bg);font-size:11px;font-weight:500;color:var(--muted);min-width:80px;}
  .chip strong{font-size:10px;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);}
  .chip span{font-size:12px;font-weight:600;color:var(--text);}
  .chip.chip--on{background:var(--chip-on);border-color:rgba(34,197,94,0.35);}
  .chip.chip--off{background:var(--chip-off);border-color:rgba(239,68,68,0.25);}
  .chip.chip--on span{color:#bbf7d0;}
  .chip.chip--off span{color:#fecaca;}
  .helper{margin-top:16px;padding:12px 14px;border-radius:var(--radius-md);background:var(--card-highlight);border:1px solid rgba(56,139,253,0.2);color:var(--muted);font-size:13px;line-height:1.5;}
  .panel{margin-top:16px;padding:14px;border-radius:var(--radius-md);border:1px dashed var(--card-border);background:var(--bg-alt);display:flex;flex-direction:column;gap:12px;}
  .actions{display:flex;gap:10px;flex-wrap:wrap;}
  .hidden{display:none !important;}
  .message-box{padding:12px 14px;border-radius:var(--radius-md);background:rgba(46,160,67,0.18);border:1px solid rgba(63,185,80,0.3);color:#c9d1d9;font-size:13px;white-space:pre-wrap;}
  .message-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
  .btn-secondary{border:1px solid var(--card-border);background:var(--bg);color:var(--muted);padding:8px 14px;border-radius:var(--radius-md);font-weight:500;cursor:pointer;transition:var(--transition);}
  .btn-secondary.danger{border-color:rgba(255,0,0,0.4);color:#f58a8a;background:rgba(127,29,29,0.25);}
  .btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
  .btn-secondary.danger:hover{border-color:#f87171;color:#f87171;}
  .placeholder{display:none;flex-direction:column;align-items:flex-start;gap:14px;padding:20px;border-radius:var(--radius-lg);border:1px dashed var(--card-border);background:var(--bg-alt);color:var(--muted);}
  .placeholder strong{font-size:16px;color:var(--text);}
  .placeholder span{opacity:0.7;font-size:13px;}
  .skeleton{display:grid;gap:14px;}
  .skeleton-card{position:relative;height:160px;border-radius:var(--radius-lg);overflow:hidden;background:var(--bg-alt);}
  .skeleton-card::after{content:"";position:absolute;inset:0;background:linear-gradient(110deg,rgba(19,31,58,0.5) 8%,rgba(59,86,132,0.75) 18%,rgba(19,31,58,0.5) 33%);animation:shimmer 1.4s linear infinite;}
  @keyframes shimmer{to{transform:translateX(100%);}}
  .form-area{margin-top:24px;}
  .form-area.hidden{display:none;}
  .card--form .card-header{margin-bottom:12px;}
  .form-body{padding-top:0;}
  @media(max-width:720px){
    .hero{padding:20px;}
    h1{font-size:20px;}
    .hero-note{font-size:11px;}
    .session-bar{flex-direction:column;gap:8px;align-items:flex-start;}
    .logout-btn{width:100%;}
    .search-bar{grid-template-columns:1fr;}
    #open-ph-btn{width:100%;justify-content:center;}
    .btn-primary{width:100%;justify-content:center;}
    .data-row{grid-template-columns:minmax(0,05fr);}
    .data-label{font-size:10px;}
    .card-grid{gap:12px;}
  }
</style>
</head>
<body>
<div class="app">
  <section class="hero">
    <h1>Clientes Phantom / GigaredPlay</h1>
    <form id="search-form" class="search-bar" autocomplete="off">
      <div class="input-wrap">
        <label for="ida">ID Phantom</label>
        <input id="ida" name="ida" placeholder="Ingresa el ID" autofocus />
      </div>
      <button id="search-submit" class="btn-primary" type="submit">
        <span class="btn-text">Buscar</span>
        <span class="spinner" aria-hidden="true"></span>
      </button>
      <button id="open-ph-btn" class="btn-secondary" type="button">Buscar directo en PH</button>
    </form>
    <div id="status" data-tone="info">Listo para buscar</div>
    <div class="session-bar">
      <span class="role-pill">{{ 'Admin' if role == 'write' else 'Solo lectura' }}</span>
      <form method="post" action="/logout">
        <button class="btn-secondary logout-btn" type="submit">Cerrar sesión</button>
      </form>
    </div>
  </section>

  <section id="out" class="results results--empty">
    <div class="placeholder">
      <strong>Ingresa un ID Phantom para ver la informacion</strong>
    </div>
  </section>

  <section id="form-area" class="form-area hidden">
    <article class="card card--form">
      <div class="card-header">
        <div>
          <p class="card-eyebrow">Formulario</p>
          <h2 class="card-title">Alta de usuario</h2>
        </div>
        <span class="badge">Registrar</span>
      </div>
      <div class="form-body">
        <div class="helper hidden" id="alta-frame-helper">Configura ALTA_URL en .env para habilitar el alta.</div>
        <div class="helper hidden" id="alta-frame-wrap">El formulario de alta se abre en una pestana nueva. Si no se abrio, revisa el bloqueador de pop-ups.</div>
      </div>
    </article>
  </section>

</div>

<script>
  const CACHE_TTL = 0;
  const resultCache = new Map();
  const CAN_WRITE = JSON.parse('{{ (role == "write")|tojson }}');
  const USER_ROLE = '{{ role }}';
  const CURRENT_USER = "{{ username }}";
  window.CAN_WRITE = CAN_WRITE;

  const form = document.getElementById('search-form');
  const input = document.getElementById('ida');
  const submitBtn = document.getElementById('search-submit');
  const statusEl = document.getElementById('status');
  const out = document.getElementById('out');
  const formArea = document.getElementById('form-area');
  const frameWrap = document.getElementById('alta-frame-wrap');
  const frameHelper = document.getElementById('alta-frame-helper');
  const phBtn = document.getElementById('open-ph-btn');
  const PH_DIRECT_URL = 'http://201.222.43.248:5594/Phantom/login.php';

  if (form) {
    form.addEventListener('submit', buscar);
  }
  if (phBtn) {
    phBtn.addEventListener('click', ()=>{
      const sep = PH_DIRECT_URL.includes('?') ? '&' : '?';
      const targetUrl = `${PH_DIRECT_URL}${sep}t=${Date.now()}`;
      const WIDTH = 1100;
      const HEIGHT = 720;
      const screenX = window.screenX ?? window.screenLeft ?? 0;
      const screenY = window.screenY ?? window.screenTop ?? 0;
      const outerWidth = window.outerWidth ?? 0;
      const outerHeight = window.outerHeight ?? 0;
      const left = Math.max(0, screenX + (outerWidth - WIDTH) / 2);
      const top = Math.max(0, screenY + (outerHeight - HEIGHT) / 2);
      const features = [
        'noopener',
        'resizable=yes',
        'scrollbars=yes',
        'status=no',
        'toolbar=no',
        'menubar=no',
        `width=${Math.round(WIDTH)}`,
        `height=${Math.round(HEIGHT)}`,
        `left=${Math.round(left)}`,
        `top=${Math.round(top)}`
      ].join(',');
      const popup = window.open(targetUrl, '_blank', features);
      if (popup) {
        popup.opener = null;
      } else {
        alert('No se pudo abrir Phantom. Revisa el bloqueador de pop-ups.');
      }
    });
  }

  function setStatus(text, tone = 'info'){
    if (!statusEl) return;
    statusEl.textContent = text;
    statusEl.dataset.tone = tone;
  }

  function setLoading(isLoading){
    if (!form || !submitBtn) return;
    form.classList.toggle('is-loading', isLoading);
    submitBtn.disabled = isLoading;
  }

  function esc(value){
    return String(value ?? '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  async function copy(text, btn){
    try{
      await navigator.clipboard.writeText(String(text ?? ''));
      if(btn){
        const previous = btn.textContent;
        btn.textContent = 'Copiado';
        btn.disabled = true;
        setTimeout(()=>{ btn.textContent = previous; btn.disabled = false; }, 1000);
      }
    }catch(error){
      console.error('No se pudo copiar', error);
      setStatus('No se pudo copiar al portapapeles', 'warn');
    }
  }

  window.copy = copy;

  function showPlaceholder(message){
    out.classList.add('results--empty');
    out.innerHTML = `<div class="placeholder"><strong>${esc(message)}</strong><span>Proba con otro ID o revisa si escribiste correctamente.</span></div>`;
    if (formArea) formArea.classList.add('hidden');
    if (frameWrap) frameWrap.classList.add('hidden');
    if (frameHelper) frameHelper.classList.add('hidden');
  }

  function showLoading(){
    out.classList.remove('results--empty');
    out.innerHTML = `<div class="skeleton"><div class="skeleton-card"></div><div class="skeleton-card"></div></div>`;
    if (formArea) formArea.classList.add('hidden');
    if (frameWrap) frameWrap.classList.add('hidden');
    if (frameHelper) frameHelper.classList.add('hidden');
  }

  function renderResult(d){
    out.classList.remove('results--empty');
    const canWrite = CAN_WRITE;

    const estCode = (d.EstadoCode || '').toLowerCase();
    const statusMap = {
      activo: {label:'Activo', cls:'badge--success'},
      suspendido: {label:'Suspendido', cls:'badge--warn'},
      baja: {label:'Baja', cls:'badge--danger'},
    };
    const statusInfo = statusMap[estCode] || {label: d.Estado || 'Sin estado', cls:''};

    const servicios = [
      {key:'TV', label:'TV'},
      {key:'HBO', label:'HBO'},
      {key:'Pack Futbol', label:'Pack Futbol'}
    ].map(({key,label}) => {
      const val = Boolean(d[key]);
      return `<div class="chip ${val ? 'chip--on' : 'chip--off'}"><strong>${esc(label)}</strong><span>${val ? 'Si' : 'No'}</span></div>`;
    }).join('');

    const creado = Boolean(d.ya_tiene_usuario);
    const altaURL = d.AltaURL || '';
    const usuarioSheet = (d.usuario_sheet || '').toString().trim();
    const abonadoSheet = (d.abonado_sheet || '').toString().trim();
    const cicSheet = (d.cic_sheet || '').toString().trim();
    const usuarioPropuesto = (d.UsuarioPropuesto || '').toString().trim();
    const cicPropuesto = (d.CICPropuesto || '').toString().trim();
    const contrasena = (d.Contrasena || '').toString().trim();
    const mensajeUsuario = usuarioPropuesto || usuarioSheet || '-';
    const msgTexto = `Se creo la cuenta correctamente. Se envio un correo para validar el email. Use el enlace para activar la cuenta (vence en 48 horas).

Usuario: ${mensajeUsuario}
Contrasena: ${contrasena || '-'}`;

    const createdClass = creado ? '' : 'hidden';

    const cardPH = `
      <article class="card">
        <div class="card-header">
          <div>
            <p class="card-eyebrow">Cliente Phantom</p>
            <h2 class="card-title">${esc(d.Nombre || 'Sin nombre')}</h2>
          </div>
          <span class="badge ${statusInfo.cls}">${esc(statusInfo.label)}</span>
        </div>
        <div class="data-list">
          <div class="data-row">
            <div class="data-label">ID Phantom</div>
            <div class="data-value">${esc(d.ID || '-')}</div>
          </div>
          <div class="data-row">
            <div class="data-label">Correo</div>
            <div class="data-value" id="v-mail">${esc(d.Mail || '-')}</div>
            <button class="copy" onclick="copy(document.getElementById('v-mail').textContent, this)">Copiar</button>
          </div>
          <div class="data-row">
            <div class="data-label">Nombre</div>
            <div class="data-value" id="v-nombre">${esc(d.Nombre || '-')}</div>
            <button class="copy" onclick="copy(document.getElementById('v-nombre').textContent, this)">Copiar</button>
          </div>
          <div class="data-row">
            <div class="data-label">DNI</div>
            <div class="data-value">${esc(d.DNI || '-')}</div>
          </div>
          <div class="data-row">
            <div class="data-label">Servicios</div>
            <div class="services">${servicios}</div>
          </div>
        </div>
      </article>`;

    const canOpenCreation = canWrite && !creado;
    const pendingClass = 'hidden';
    const creationPanel = canWrite
      ? `
          <div id="alta-panel" class="panel ${pendingClass}">
            <div class="data-row" style="grid-template-columns:110px minmax(0,1fr);">
              <div class="data-label">Usuario</div>
              <div class="data-value" id="v-user">${esc(usuarioPropuesto || '-')}</div>
            </div>
            <div class="data-row" style="grid-template-columns:110px minmax(0,1fr) min-content;">
              <div class="data-label">CIC</div>
              <div class="data-value" id="v-cic">${esc(cicPropuesto || '-')}</div>
              ${cicPropuesto ? `<button class="copy" onclick="copy(document.getElementById('v-cic').textContent, this)">Copiar</button>` : ''}
            </div>
            <div class="data-row" style="grid-template-columns:110px minmax(0,1fr) min-content;">
              <div class="data-label">Contrasena por defecto</div>
              <div class="data-value" id="v-pwd-def">${esc(contrasena || '-')}</div>
              <button class="copy" onclick="copy(document.getElementById('v-pwd-def').textContent, this)">Copiar</button>
            </div>
            <div class="actions">
              <button id="btn-registrar" class="btn-secondary" data-alta-url="${esc(altaURL)}" onclick="onRegistrarInline(this)">Registrar</button>
              <button id="btn-finalizar" class="btn-secondary" style="display:none" onclick="onFinalizar()">Finalizar</button>
            </div>
            <div id="msg-panel" class="hidden">
              <div class="message-box" id="v-msg">${esc(msgTexto)}</div>
              <div class="message-actions">
                <button class="btn-secondary" onclick="copy(document.getElementById('v-msg').textContent, this)">Copiar mensaje</button>
              </div>
            </div>
          </div>
        `
      : (!creado ? `<div class="helper">No tenes permisos para crear usuarios.</div>` : '');

    const cardSheet = `
      <article class="card" id="card-sheet">
        <div class="card-header">
          <div>
            <p class="card-eyebrow">GigaredPlay</p>
            <h2 class="card-title" id="card-sheet-title">${creado ? 'Usuario creado' : 'Sin usuario'}</h2>
          </div>
          <span class="badge ${creado ? 'badge--success' : ''}" id="card-sheet-badge">${creado ? 'Listo' : 'Accion'}</span>
        </div>
        <div class="data-list">
          <div class="data-row">
            <div class="data-value" id="val-creado">${creado ? '' : ''}</div>
            ${canOpenCreation ? `<button id="btn-crear" class="btn-secondary" data-target="alta-panel" onclick="toggleExp(this)">Crear usuario</button>` : ''}
          </div>
          <div class="data-row ${createdClass}" data-created-row>
            <div class="data-label">Usuario</div>
            <div class="data-value" id="v-usuario">${esc(usuarioSheet || '-')}</div>
            ${usuarioSheet ? `<button class="copy" onclick="copy(document.getElementById('v-usuario').textContent, this)">Copiar</button>` : ''}
          </div>
          <div class="data-row ${createdClass}" data-created-row>
            <div class="data-label">Contrasena</div>
            <div class="data-value" id="v-pwd">${esc(contrasena || '-')}</div>
            ${contrasena ? `<button class="copy" onclick="copy(document.getElementById('v-pwd').textContent, this)">Copiar</button>` : ''}
          </div>
          ${creationPanel}
        </div>
      </article>`;

    out.innerHTML = `<div class="card-grid" id="card-grid">${cardPH}${cardSheet}</div>`;
    setStatus('Respuesta lista', 'success');
    setTimeout(()=>{ out.scrollIntoView({behavior:'smooth', block:'start'}); }, 150);

    if (formArea) {
      formArea.classList.add('hidden');
      if (canWrite) {
        formArea.dataset.altaUrl = altaURL;
      } else {
        formArea.removeAttribute('data-alta-url');
      }
    }
    if (frameWrap) frameWrap.classList.add('hidden');
    if (frameHelper) frameHelper.classList.add('hidden');
  }

  async function buscar(event){
    if (event) event.preventDefault();
    const ida = (input?.value || '').trim();
    if (!ida){
      setStatus('Ingresa un ID valido', 'warn');
      showPlaceholder('Ingresa un ID valido.');
      return;
    }

    setStatus('Buscando cliente...', 'loading');
    setLoading(true);
    showLoading();

    const cacheHit = resultCache.get(ida);
    const now = Date.now();
    if (cacheHit && now - cacheHit.ts < CACHE_TTL){
      renderResult(cacheHit.data);
      setLoading(false);
      setStatus('Resultado desde cache reciente', 'success');
      return;
    }

    try{
      const res = await fetch(`/api/cliente?ida=${encodeURIComponent(ida)}`);
      if(!res.ok){
        const msg = await res.text();
        throw new Error(`HTTP ${res.status} ${msg}`);
      }
      const data = await res.json();
      resultCache.set(ida, {ts: now, data});
      renderResult(data);
      setLoading(false);
    }catch(error){
      console.error(error);
      setLoading(false);
      setStatus('No se pudo obtener el cliente', 'error');
      showPlaceholder(error.message || 'No se pudo obtener el cliente');
    }
  }

  function toggleExp(btn, id, labelOn = 'Cancelar', labelOff = 'Crear usuario'){
    const targetId = id || btn?.dataset?.target;
    if (!targetId) return;
    const el = document.getElementById(targetId);
    if (!el) return;
    const willShow = el.classList.contains('hidden');
    el.classList.toggle('hidden');
    if (willShow){
      btn.textContent = labelOn;
      btn.classList.add('danger');
    } else {
      btn.textContent = labelOff;
      btn.classList.remove('danger');
    }
  }

  window.toggleExp = toggleExp;
  function onRegistrarInline(btn){
    if (!CAN_WRITE) {
      alert('No tenes permisos para crear usuarios.');
      return;
    }
    const finishBtn = document.getElementById('btn-finalizar');
    const msg = document.getElementById('msg-panel');
    const altaUrl = (btn?.dataset?.altaUrl || formArea?.dataset?.altaUrl || '').trim();
    if (formArea) formArea.dataset.altaUrl = altaUrl;

    const opened = btn.dataset.state === 'open';
    if (!opened){
      if (formArea) formArea.classList.remove('hidden');
      if (altaUrl){
        if (frameWrap) frameWrap.classList.remove('hidden');
        if (frameHelper) frameHelper.classList.add('hidden');
        const sep = altaUrl.includes('?') ? '&' : '?';
        const targetUrl = `${altaUrl}${sep}t=${Date.now()}`;
        const popup = window.open(targetUrl, '_blank');
        if (popup) popup.opener = null;
      } else {
        if (frameWrap) frameWrap.classList.add('hidden');
        if (frameHelper) frameHelper.classList.remove('hidden');
      }
      btn.dataset.state = 'open';
      btn.textContent = 'Cancelar';
      btn.classList.add('danger');
      if (finishBtn) finishBtn.style.display = 'inline-flex';
      if (msg) msg.classList.add('hidden');
    } else {
      if (formArea) formArea.classList.add('hidden');
      if (frameWrap) frameWrap.classList.add('hidden');
      if (frameHelper) frameHelper.classList.add('hidden');
      btn.dataset.state = '';
      btn.textContent = 'Registrar';
      btn.classList.remove('danger');
      if (finishBtn) finishBtn.style.display = 'none';
      if (msg) msg.classList.add('hidden');
    }
  }

  window.onRegistrarInline = onRegistrarInline;

  async function onFinalizar(){
    if (!CAN_WRITE) {
      alert('No tenes permisos para crear usuarios.');
      return;
    }
    const btnCrear = document.getElementById('btn-crear');
    const btnReg = document.getElementById('btn-registrar');
    const btnFin = document.getElementById('btn-finalizar');
    const msgPanel = document.getElementById('msg-panel');
    const valCreado = document.getElementById('val-creado');
    const cardTitle = document.getElementById('card-sheet-title');
    const badge = document.getElementById('card-sheet-badge');
    const usuarioEl = document.getElementById('v-usuario');
    const abonadoEl = document.getElementById('v-abonado');
    const cicRealEl = document.getElementById('v-cic-real');
    const pwdEl = document.getElementById('v-pwd');
    const usuario = (document.getElementById('v-user')?.textContent || '').trim();
    const ida = (input?.value || '').trim();
    const nombre = (document.getElementById('v-nombre')?.textContent || '').trim();
    const cicSugerido = (document.getElementById('v-cic')?.textContent || '').trim();

    if (!usuario){ alert('No hay usuario propuesto para marcar.'); return; }
    if (!ida){ alert('No hay ID de Phantom.'); return; }

    try{
      const resp = await fetch('/api/marcar_registro', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({usuario, ida, nombre})
      });
      if (!resp.ok){
        const detail = await resp.text();
        throw new Error(detail);
      }
      await resp.json();
    }catch(error){
      alert('No se pudo escribir en el Sheet: ' + error);
      return;
    }

    if (btnReg){
      btnReg.dataset.state = '';
      btnReg.textContent = 'Registrar';
      btnReg.classList.remove('danger');
      btnReg.style.display = 'none';
    }
    if (btnFin) btnFin.style.display = 'none';
    if (frameWrap) frameWrap.classList.add('hidden');
    if (frameHelper) frameHelper.classList.add('hidden');
    if (formArea) formArea.classList.add('hidden');

    if (msgPanel){
      msgPanel.classList.remove('hidden');
      msgPanel.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
    if (valCreado) valCreado.textContent = 'Si';
    if (btnCrear) btnCrear.style.display = 'none';
    if (cardTitle) cardTitle.textContent = 'Usuario creado';
    if (badge){
      badge.textContent = 'Listo';
      badge.classList.add('badge--success');
    }

    document.querySelectorAll('[data-created-row]').forEach(row => row.classList.remove('hidden'));
    if (usuarioEl && usuario) usuarioEl.textContent = usuario;
    if (cicRealEl && cicSugerido) cicRealEl.textContent = cicSugerido;
    if (pwdEl) pwdEl.textContent = (document.getElementById('v-pwd-def')?.textContent || pwdEl.textContent || '-');

    const cacheEntry = resultCache.get(ida);
    if (cacheEntry){
      cacheEntry.data.ya_tiene_usuario = true;
      cacheEntry.data.usuario_sheet = cacheEntry.data.usuario_sheet || usuario;
      cacheEntry.data.cic_sheet = cacheEntry.data.cic_sheet || cicSugerido;
      cacheEntry.data.abonado_sheet = cacheEntry.data.abonado_sheet || (abonadoEl?.textContent || '');
      cacheEntry.data.Contrasena = cacheEntry.data.Contrasena || pwdEl?.textContent || '';
      resultCache.set(ida, {ts: Date.now(), data: cacheEntry.data});
    }
  }

  window.onFinalizar = onFinalizar;

  setTimeout(()=>{ input?.focus(); }, 200);
</script>
</body>
</html>
